<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.0/plotly.min.js"></script>
    <title>Hypersonic Glide Vehicle Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* Typography */
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: #34495e;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Input section styling */
        .input-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .parameter-group {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .parameter-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .input-row:last-child {
            margin-bottom: 0;
        }

        label {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
            min-width: 200px;
        }

        input[type="number"] {
            flex: 0 0 120px;
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        input[type="number"]:hover {
            border-color: #764ba2;
        }

        /* Button styling */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #simulateBtn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        #footprintBtn {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        #resetBtn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        #exportBtn {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
            margin-bottom: 20px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(-1px);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        /* Loading indicator */
        #loading {
            text-align: center;
            padding: 40px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #loading p {
            font-size: 18px;
            font-weight: 500;
            color: #667eea;
        }

        /* Results section */
        #results-section, #footprint-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* Statistics styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .stat-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        /* Plot containers - SIMPLIFIED FOR PLOTLY COMPATIBILITY */
        #plots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .plot-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .plot-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        /* Data table styling */
        #data-table-section {
            margin-top: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        #data-table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
        }

        #data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #data-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e1e8ed;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        #data-table tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* Error section */
        #error-section {
            background: linear-gradient(145deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
        }

        #error-message {
            font-weight: 500;
            text-align: center;
        }

        /* Footprint image styling */
        #plot-footprint {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: block;
            margin: 0 auto;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            label {
                min-width: auto;
            }
            
            input[type="number"] {
                flex: 1;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            #plots-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .plot-container {
                min-width: auto;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .input-section, #results-section, #footprint-section {
                padding: 20px;
            }
            
            .parameter-group {
                padding: 15px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
        }
        /* Map section styling */
        #map-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        #map-container {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .control-group input {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            width: 120px;
        }

        #projectFootprintBtn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #projectFootprintBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .direction-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            z-index: 1000;
        }

        /* Footprint legend */
        .footprint-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        /* Loading overlay for map */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            border-radius: 12px;
        }

        .map-loading p {
            font-size: 16px;
            font-weight: 500;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hypersonic Glide Vehicle Simulator</h1>
        
        <!-- Input Parameters Form -->
        <div class="input-section">
            <h2>Vehicle Parameters</h2>
            <form id="simulationForm">
                <!-- Initial Conditions -->
                <div class="parameter-group">
                    <h3>Initial Conditions</h3>
                    <div class="input-row">
                        <label for="v0">Initial Velocity (km/s):</label>
                        <input type="number" id="v0" name="v0" value="7.5" step="0.1" min="1" max="15">
                    </div>
                    <div class="input-row">
                        <label for="gammad0">Initial Flight Path Angle (deg):</label>
                        <input type="number" id="gammad0" name="gammad0" value="-2.0" step="0.1" min="-45" max="45">
                    </div>
                    <div class="input-row">
                        <label for="rolld0">Initial Roll Angle (deg):</label>
                        <input type="number" id="rolld0" name="rolld0" value="0" step="1" min="-90" max="90">
                    </div>
                    <div class="input-row">
                        <label for="kappad0">Initial Heading Angle (deg):</label>
                        <input type="number" id="kappad0" name="kappad0" value="0" step="1" min="-180" max="180">
                    </div>
                    <div class="input-row">
                        <label for="r0">Initial Range (km):</label>
                        <input type="number" id="r0" name="r0" value="0" step="1" min="0" max="1000">
                    </div>
                    <div class="input-row">
                        <label for="cr0">Initial Crossrange (km):</label>
                        <input type="number" id="cr0" name="cr0" value="0" step="1" min="-1000" max="1000">
                    </div>
                    <div class="input-row">
                        <label for="t0">Initial Time (s):</label>
                        <input type="number" id="t0" name="t0" value="0" step="1" min="0" max="1000">
                    </div>
                </div>

                <!-- Vehicle Properties -->
                <div class="parameter-group">
                    <h3>Vehicle Properties</h3>
                    <div class="input-row">
                        <label for="payload">Payload Mass (kg):</label>
                        <input type="number" id="payload" name="payload" value="1000" step="10" min="100" max="10000">
                    </div>
                    <div class="input-row">
                        <label for="beta">Ballistic Coefficient (kg/m²):</label>
                        <input type="number" id="beta" name="beta" value="500" step="10" min="100" max="2000">
                    </div>
                    <div class="input-row">
                        <label for="LtoD">Lift-to-Drag Ratio:</label>
                        <input type="number" id="LtoD" name="LtoD" value="3.0" step="0.1" min="0.5" max="10">
                    </div>
                    <div class="input-row">
                        <label for="emis">Surface Emissivity:</label>
                        <input type="number" id="emis" name="emis" value="0.8" step="0.01" min="0.1" max="1.0">
                    </div>
                </div>

                <!-- Thermal Analysis Parameters -->
                <div class="parameter-group">
                    <h3>Thermal Analysis</h3>
                    <div class="input-row">
                        <label for="distance1">Distance 1 (m):</label>
                        <input type="number" id="distance1" name="distance1" value="1.0" step="0.1" min="0.1" max="10">
                    </div>
                    <div class="input-row">
                        <label for="distance2">Distance 2 (m):</label>
                        <input type="number" id="distance2" name="distance2" value="2.0" step="0.1" min="0.1" max="10">
                    </div>
                </div>

                <!-- IR Sensor Wavelengths -->
                <div class="parameter-group">
                    <h3>IR Sensor Wavelengths (μm)</h3>
                    <div class="input-row">
                        <label for="lam1">SBIRS λ₁:</label>
                        <input type="number" id="lam1" name="lam1" value="2.7" step="0.1" min="1" max="20">
                    </div>
                    <div class="input-row">
                        <label for="lam2">SBIRS λ₂:</label>
                        <input type="number" id="lam2" name="lam2" value="2.9" step="0.1" min="1" max="20">
                    </div>
                    <div class="input-row">
                        <label for="lam3">DSP λ₃:</label>
                        <input type="number" id="lam3" name="lam3" value="4.2" step="0.1" min="1" max="20">
                    </div>
                    <div class="input-row">
                        <label for="lam4">DSP λ₄:</label>
                        <input type="number" id="lam4" name="lam4" value="4.8" step="0.1" min="1" max="20">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="button-group">
                    <button type="button" id="simulateBtn">Run Simulation</button>
                    <button type="button" id="footprintBtn">Calculate Footprint</button>
                    <button type="button" id="resetBtn">Reset Parameters</button>
                </div>
            </form>
        </div>

        <!-- Loading indicator -->
        <div id="loading" style="display: none;">
            <p>Running simulation... Please wait.</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" style="display: none;">
            <h2>Simulation Results</h2>
            
            <!-- Summary Statistics -->
            <div id="summary-stats">
                <h3>Summary Statistics</h3>
                <div id="stats-content"></div>
            </div>

            <div id="plots-grid">
                <div class="plot-container">
                    <h3>Altitude vs Range</h3>
                    <div id="plot-altitude-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>Velocity vs Range</h3>
                    <div id="plot-velocity-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>Flight Time vs Range</h3>
                    <div id="plot-time-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>Cross Range vs Range</h3>
                    <div id="plot-crossrange-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>Temperature 1 vs Range</h3>
                    <div id="plot-t1-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>Temperature 2 vs Range</h3>
                    <div id="plot-t2-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>DSP IR Intensity vs Range</h3>
                    <div id="plot-ir-dsp-range" style="width: 100%; height: 400px;"></div>
                </div>
                
                <div class="plot-container">
                    <h3>SBIRS IR Intensity vs Range</h3>
                    <div id="plot-ir-sbirs-range" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <!-- Data Table -->
            <div id="data-table-section">
                <h3>Simulation Data</h3>
                <button id="exportBtn">Export to CSV</button>
                <div id="data-table-container">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Time (s)</th>
                                <th>Altitude (km)</th>
                                <th>Velocity (km/s)</th>
                                <th>Range (km)</th>
                                <th>Crossrange (km)</th>
                                <th>Temp 1 (K)</th>
                                <th>Temp 2 (K)</th>
                                <th>IR SBIRS</th>
                                <th>IR DSP</th>
                                <th>Boundary Layer</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footprint Results Section -->
        <div id="footprint-section" style="display: none;">
            <h2>Footprint Analysis Results</h2>
            
            <div id="footprint-stats">
                <h3>Footprint Statistics</h3>
                <div id="footprint-stats-content"></div>
            </div>

            <div class="plot-container">
                <h3>Glider Footprint</h3>
                <img id="plot-footprint" src="" alt="Glider Footprint">
            </div>
        </div>

        <div id="map-section" style="display: none;">
            <h2>Footprint Map Projection</h2>
            
            <div class="map-controls">
                <div class="control-group">
                    <label for="start-latitude">Start Latitude:</label>
                    <input type="number" id="start-latitude" value="37.7749" step="0.0001" min="-90" max="90">
                </div>
                <div class="control-group">
                    <label for="start-longitude">Start Longitude:</label>
                    <input type="number" id="start-longitude" value="-122.4194" step="0.0001" min="-180" max="180">
                </div>
                <div class="control-group">
                    <label for="flight-direction">Flight Direction (°):</label>
                    <input type="number" id="flight-direction" value="45" step="1" min="0" max="359">
                </div>
                <button type="button" id="projectFootprintBtn">Project Footprint</button>
            </div>
            
            <div id="map-container">
                <div id="map"></div>
                <div class="direction-indicator">
                    Click on map to set start location, or use coordinates above
                </div>
                <div class="footprint-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span>Roll +90° (Right Turn)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #44ff44;"></div>
                        <span>Roll 0° (Straight)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4444ff;"></div>
                        <span>Roll -90° (Left Turn)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffaa00;"></div>
                        <span>Roll ±45°</span>
                    </div>
                </div>
                <div id="map-loading" class="map-loading" style="display: none;">
                    <p>Projecting footprint onto map...</p>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="error-section" style="display: none;">
            <h3>Error</h3>
            <div id="error-message"></div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // Default parameters
        const defaultParams = {
            v0: 7.5,
            rolld0: 0,
            gammad0: -2.0,
            kappad0: 0,
            r0: 0,
            cr0: 0,
            t0: 0,
            payload: 1000,
            beta: 500,
            LtoD: 3.0,
            emis: 0.8,
            distance1: 1.0,
            distance2: 2.0,
            lam1: 2.7,
            lam2: 2.9,
            lam3: 4.2,
            lam4: 4.8
        };

        // Global variables to store results
        let currentResults = null;
        let map = null;
        let startMarker = null;
        let directionArrow = null;
        let footprintLayers = [];
        let currentFootprintData = null;

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('simulateBtn').addEventListener('click', runSimulation);
            document.getElementById('footprintBtn').addEventListener('click', calculateFootprint);
            document.getElementById('resetBtn').addEventListener('click', resetParameters);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        });

        // Get form data as object
        function getFormData() {
            const form = document.getElementById('simulationForm');
            const formData = new FormData(form);
            const params = {};
            
            for (let [key, value] of formData.entries()) {
                params[key] = parseFloat(value);
            }
            
            return params;
        }

        // Reset form to default parameters
        function resetParameters() {
            for (const [key, value] of Object.entries(defaultParams)) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
            
            // Hide results sections
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('footprint-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('footprint-section').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-section').style.display = 'block';
            hideLoading();
        }

        // Run main simulation
        async function runSimulation() {
            showLoading();
            
            try {
                const params = getFormData();
                
                const response = await fetch('/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentResults = data.results;
                    displayResults(data.results, data.plots);
                    document.getElementById('results-section').style.display = 'block';
                } else {
                    showError(data.error || 'Simulation failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            }
            
            hideLoading();
        }

        // Calculate footprint analysis
        async function calculateFootprint() {
            showLoading();
            
            try {
                const params = getFormData();
                
                const response = await fetch('/footprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayFootprintResults(data);
                    document.getElementById('footprint-section').style.display = 'block';
                } else {
                    showError(data.error || 'Footprint calculation failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            }
            
            hideLoading();
        }

        // Display simulation results
        function displayResults(results, plots) {
            // Display summary statistics
            displaySummaryStats(results);
            
            // Display plots
            displayPlots(plots);
            
            // Display data table
            displayDataTable(results);
        }

        // Display summary statistics
        function displaySummaryStats(results) {
            const statsContainer = document.getElementById('stats-content');
            
            if (results.range.length === 0) {
                statsContainer.innerHTML = '<p>No simulation data available.</p>';
                return;
            }
            
            const finalIndex = results.range.length - 1;
            const maxAltitude = Math.max(...results.altitude);
            const maxVelocity = Math.max(...results.velocity);
            const finalRange = results.range[finalIndex];
            const finalCrossrange = results.crossrange[finalIndex];
            const flightTime = results.time[finalIndex];
            const maxTemp1 = Math.max(...results.T1);
            const maxTemp2 = Math.max(...results.T2);
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Final Range:</strong> ${finalRange.toFixed(2)} km
                    </div>
                    <div class="stat-item">
                        <strong>Final Crossrange:</strong> ${finalCrossrange.toFixed(2)} km
                    </div>
                    <div class="stat-item">
                        <strong>Flight Time:</strong> ${flightTime.toFixed(1)} s
                    </div>
                    <div class="stat-item">
                        <strong>Max Altitude:</strong> ${maxAltitude.toFixed(2)} km
                    </div>
                    <div class="stat-item">
                        <strong>Max Velocity:</strong> ${maxVelocity.toFixed(2)} km/s
                    </div>
                    <div class="stat-item">
                        <strong>Max Temp 1:</strong> ${maxTemp1.toFixed(0)} K
                    </div>
                    <div class="stat-item">
                        <strong>Max Temp 2:</strong> ${maxTemp2.toFixed(0)} K
                    </div>
                </div>
            `;
        }

        function displayPlots(plots) {
            // Create interactive plots instead of displaying images
            createInteractivePlot('plot-altitude-range', currentResults.range, currentResults.altitude, 
                                'Range (km)', 'Altitude (km)', 'Altitude vs Range');
            
            createInteractivePlot('plot-velocity-range', currentResults.range, currentResults.velocity, 
                                'Range (km)', 'Velocity (km/s)', 'Velocity vs Range');
            
            createInteractivePlot('plot-time-range', currentResults.range, currentResults.time, 
                                'Range (km)', 'Time (s)', 'Flight Time vs Range');
            
            createInteractivePlot('plot-crossrange-range', currentResults.range, currentResults.crossrange, 
                                'Range (km)', 'Crossrange (km)', 'Cross Range vs Range');
            
            createInteractivePlot('plot-t1-range', currentResults.range, currentResults.T1, 
                                'Range (km)', 'Temperature 1 (K)', 'Temperature 1 vs Range');
            
            createInteractivePlot('plot-t2-range', currentResults.range, currentResults.T2, 
                                'Range (km)', 'Temperature 2 (K)', 'Temperature 2 vs Range');
            
            createInteractivePlot('plot-ir-dsp-range', currentResults.range, currentResults.IR_DSP, 
                                'Range (km)', 'IR Intensity', 'DSP IR Intensity vs Range');
            
            createInteractivePlot('plot-ir-sbirs-range', currentResults.range, currentResults.IR_SBIRS, 
                                'Range (km)', 'IR Intensity', 'SBIRS IR Intensity vs Range');
        }

        // Create interactive plot with crosshairs and tooltips
        function createInteractivePlot(containerId, xData, yData, xTitle, yTitle, plotTitle) {
            const trace = {
                x: xData,
                y: yData,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#1f77b4', width: 2 },
                hovertemplate: `<b>${xTitle}:</b> %{x:.3f}<br><b>${yTitle}:</b> %{y:.3f}<extra></extra>`
            };

            const layout = {
                title: {
                    text: plotTitle,
                    font: { size: 16 }
                },
                xaxis: {
                    title: xTitle,
                    showgrid: true,
                    gridcolor: '#ddd',
                    showspikes: true,
                    spikecolor: '#999',
                    spikethickness: 1,
                    spikedash: 'dot',
                    spikemode: 'across'
                },
                yaxis: {
                    title: yTitle,
                    showgrid: true,
                    gridcolor: '#ddd',
                    showspikes: true,
                    spikecolor: '#999',
                    spikethickness: 1,
                    spikedash: 'dot',
                    spikemode: 'across'
                },
                hovermode: 'closest',
                showlegend: false,
                margin: { l: 60, r: 40, t: 60, b: 60 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };

            const config = {
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
                displaylogo: false,
                responsive: true
            };

            Plotly.newPlot(containerId, [trace], layout, config);
        }

        // Display data table
        function displayDataTable(results) {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            for (let i = 0; i < results.time.length; i++) {
                const row = tbody.insertRow();
                
                const cells = [
                    results.time[i].toFixed(1),
                    results.altitude[i].toFixed(3),
                    results.velocity[i].toFixed(3),
                    results.range[i].toFixed(3),
                    results.crossrange[i].toFixed(3),
                    results.T1[i].toFixed(1),
                    results.T2[i].toFixed(1),
                    results.IR_SBIRS[i].toExponential(3),
                    results.IR_DSP[i].toExponential(3),
                    results.boundary_layer[i]
                ];
                
                cells.forEach(cellData => {
                    const cell = row.insertCell();
                    cell.textContent = cellData;
                });
            }
        }

        // Display footprint results
        function displayFootprintResults(data) {
            const statsContainer = document.getElementById('footprint-stats-content');
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Footprint Area:</strong> ${data.footprint_area.toFixed(0)} km²
                    </div>
                    <div class="stat-item">
                        <strong>Trajectories Calculated:</strong> ${data.trajectories_count}
                    </div>
                </div>
            `;
            
            // Display footprint plot
            if (data.plot) {
                const plotElement = document.getElementById('plot-footprint');
                plotElement.src = 'data:image/png;base64,' + data.plot;
                plotElement.style.display = 'block';
            }
        }

        // Export results to CSV
        function exportToCSV() {
            if (!currentResults) {
                alert('No simulation data available to export.');
                return;
            }
            
            const headers = [
                'Time (s)', 'Altitude (km)', 'Velocity (km/s)', 'Range (km)', 
                'Crossrange (km)', 'Pathlength (km)', 'Gamma (deg)', 'Kappa (deg)',
                'T_sp (K)', 'T1 (K)', 'T2 (K)', 'IR_SBIRS', 'IR_DSP', 'Boundary_Layer'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            for (let i = 0; i < currentResults.time.length; i++) {
                const row = [
                    currentResults.time[i],
                    currentResults.altitude[i],
                    currentResults.velocity[i],
                    currentResults.range[i],
                    currentResults.crossrange[i],
                    currentResults.pathlength[i],
                    currentResults.gamma_deg[i],
                    currentResults.kappa_deg[i],
                    currentResults.T_sp[i],
                    currentResults.T1[i],
                    currentResults.T2[i],
                    currentResults.IR_SBIRS[i],
                    currentResults.IR_DSP[i],
                    currentResults.boundary_layer[i]
                ];
                csvContent += row.join(',') + '\n';
            }
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hypersonic_simulation_results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize the map
        function initializeMap() {
            if (map) {
                map.remove();
            }
            
            map = L.map('map').setView([37.7749, -122.4194], 8);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Add click handler for setting start location
            map.on('click', function(e) {
                setStartLocation(e.latlng.lat, e.latlng.lng);
            });
        }

        // Set start location on map
        function setStartLocation(lat, lng) {
            // Update input fields
            document.getElementById('start-latitude').value = lat.toFixed(6);
            document.getElementById('start-longitude').value = lng.toFixed(6);
            
            // Remove existing marker
            if (startMarker) {
                map.removeLayer(startMarker);
            }
            
            // Add new marker
            startMarker = L.marker([lat, lng], {
                draggable: true,
                title: 'Start Location'
            }).addTo(map);
            
            // Handle marker drag
            startMarker.on('dragend', function(e) {
                const position = e.target.getLatLng();
                setStartLocation(position.lat, position.lng);
            });
            
            updateDirectionArrow();
        }

        // Update direction arrow
        function updateDirectionArrow() {
            if (!startMarker) return;
            
            const startPos = startMarker.getLatLng();
            const direction = parseFloat(document.getElementById('flight-direction').value);
            
            // Calculate end point for arrow (50km ahead)
            const endPos = calculateDestination(startPos.lat, startPos.lng, direction, 50);
            
            // Remove existing arrow
            if (directionArrow) {
                map.removeLayer(directionArrow);
            }
            
            // Create direction arrow
            directionArrow = L.polyline([
                [startPos.lat, startPos.lng],
                [endPos.lat, endPos.lng]
            ], {
                color: '#667eea',
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            // Add arrowhead
            const arrowHead = L.marker([endPos.lat, endPos.lng], {
                icon: L.divIcon({
                    html: '➤',
                    iconSize: [20, 20],
                    className: 'arrow-icon',
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            // Group arrow components
            directionArrow.arrowHead = arrowHead;
        }

        // Calculate destination point given start point, bearing and distance
        function calculateDestination(lat1, lon1, bearing, distance) {
            const R = 6371; // Earth's radius in km
            const φ1 = lat1 * Math.PI / 180;
            const λ1 = lon1 * Math.PI / 180;
            const θ = bearing * Math.PI / 180;
            
            const φ2 = Math.asin(Math.sin(φ1) * Math.cos(distance / R) +
                                Math.cos(φ1) * Math.sin(distance / R) * Math.cos(θ));
            
            const λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(distance / R) * Math.cos(φ1),
                                    Math.cos(distance / R) - Math.sin(φ1) * Math.sin(φ2));
            
            return {
                lat: φ2 * 180 / Math.PI,
                lng: λ2 * 180 / Math.PI
            };
        }

        // Calculate bearing between two points
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            
            const θ = Math.atan2(y, x);
            return (θ * 180 / Math.PI + 360) % 360;
        }

        // Project footprint onto map
        async function projectFootprintOnMap() {
            if (!currentFootprintData) {
                alert('Please calculate footprint first before projecting on map.');
                return;
            }
            
            const startLat = parseFloat(document.getElementById('start-latitude').value);
            const startLng = parseFloat(document.getElementById('start-longitude').value);
            const flightDirection = parseFloat(document.getElementById('flight-direction').value);
            
            if (isNaN(startLat) || isNaN(startLng) || isNaN(flightDirection)) {
                alert('Please enter valid coordinates and flight direction.');
                return;
            }
            
            document.getElementById('map-loading').style.display = 'flex';
            
            try {
                // Clear existing footprint layers
                footprintLayers.forEach(layer => map.removeLayer(layer));
                footprintLayers = [];
                
                // Project each footprint curve
                const rollAngles = [-90, -45, 0, 45, 90];
                const colors = ['#4444ff', '#8888ff', '#44ff44', '#ffaa00', '#ff4444'];
                
                rollAngles.forEach((rollAngle, index) => {
                    const footprintCurve = currentFootprintData.curves[rollAngle];
                    if (footprintCurve && footprintCurve.length > 0) {
                        const projectedPoints = projectFootprintCurve(
                            footprintCurve, startLat, startLng, flightDirection
                        );
                        
                        // Create left and right mirrored curves
                        const leftCurve = projectedPoints.left;
                        const rightCurve = projectedPoints.right;
                        
                        // Add curves to map
                        if (leftCurve.length > 0) {
                            const leftPolyline = L.polyline(leftCurve, {
                                color: colors[index],
                                weight: 3,
                                opacity: 0.8,
                                dashArray: rollAngle === 0 ? null : '5, 5'
                            }).addTo(map);
                            footprintLayers.push(leftPolyline);
                        }
                        
                        if (rightCurve.length > 0) {
                            const rightPolyline = L.polyline(rightCurve, {
                                color: colors[index],
                                weight: 3,
                                opacity: 0.8,
                                dashArray: rollAngle === 0 ? null : '5, 5'
                            }).addTo(map);
                            footprintLayers.push(rightPolyline);
                        }
                    }
                });
                
                // Fit map to show all footprint data
                if (footprintLayers.length > 0) {
                    const group = new L.featureGroup(footprintLayers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
            } catch (error) {
                console.error('Error projecting footprint:', error);
                alert('Error projecting footprint: ' + error.message);
            }
            
            document.getElementById('map-loading').style.display = 'none';
        }

        // Project a single footprint curve onto map coordinates
        function projectFootprintCurve(footprintCurve, startLat, startLng, flightDirection) {
            const leftCurve = [];
            const rightCurve = [];
            
            footprintCurve.forEach(point => {
                // Convert local coordinates (range, crossrange) to lat/lng
                const range = point.range; // km along flight path
                const crossrange = point.crossrange; // km perpendicular to flight path
                
                // Calculate position along flight path
                const flightPathPoint = calculateDestination(startLat, startLng, flightDirection, range);
                
                // Calculate perpendicular bearing for crossrange
                const perpBearingLeft = (flightDirection - 90 + 360) % 360;
                const perpBearingRight = (flightDirection + 90) % 360;
                
                // Project crossrange to both sides
                if (crossrange !== 0) {
                    const leftPoint = calculateDestination(
                        flightPathPoint.lat, flightPathPoint.lng, 
                        perpBearingLeft, Math.abs(crossrange)
                    );
                    const rightPoint = calculateDestination(
                        flightPathPoint.lat, flightPathPoint.lng, 
                        perpBearingRight, Math.abs(crossrange)
                    );
                    
                    leftCurve.push([leftPoint.lat, leftPoint.lng]);
                    rightCurve.push([rightPoint.lat, rightPoint.lng]);
                } else {
                    // On centerline
                    leftCurve.push([flightPathPoint.lat, flightPathPoint.lng]);
                    rightCurve.push([flightPathPoint.lat, flightPathPoint.lng]);
                }
            });
            
            return { left: leftCurve, right: rightCurve };
        }

        
        async function calculateFootprint() {
            showLoading();
            
            try {
                const params = getFormData();
                
                const response = await fetch('/footprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentFootprintData = data.footprint_data; // Store for map projection
                    displayFootprintResults(data);
                    document.getElementById('footprint-section').style.display = 'block';
                    
                    // Show map section and initialize if not done
                    document.getElementById('map-section').style.display = 'block';
                    if (!map) {
                        setTimeout(initializeMap, 100); // Small delay to ensure container is visible
                    }
                } else {
                    showError(data.error || 'Footprint calculation failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            }
            
            hideLoading();
        }

        // Add event listeners for map functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Existing event listeners...
            document.getElementById('simulateBtn').addEventListener('click', runSimulation);
            document.getElementById('footprintBtn').addEventListener('click', calculateFootprint);
            document.getElementById('resetBtn').addEventListener('click', resetParameters);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            
            // New map event listeners
            document.getElementById('projectFootprintBtn').addEventListener('click', projectFootprintOnMap);
            
            // Update direction arrow when flight direction changes
            document.getElementById('flight-direction').addEventListener('input', function() {
                if (startMarker) {
                    updateDirectionArrow();
                }
            });
            
            // Update marker when coordinates change manually
            document.getElementById('start-latitude').addEventListener('change', function() {
                const lat = parseFloat(this.value);
                const lng = parseFloat(document.getElementById('start-longitude').value);
                if (!isNaN(lat) && !isNaN(lng)) {
                    setStartLocation(lat, lng);
                    if (map) {
                        map.setView([lat, lng], map.getZoom());
                    }
                }
            });
            
            document.getElementById('start-longitude').addEventListener('change', function() {
                const lat = parseFloat(document.getElementById('start-latitude').value);
                const lng = parseFloat(this.value);
                if (!isNaN(lat) && !isNaN(lng)) {
                    setStartLocation(lat, lng);
                    if (map) {
                        map.setView([lat, lng], map.getZoom());
                    }
                }
            });
        });

        // Add CSS for arrow icon
        const style = document.createElement('style');
        style.textContent = `
            .arrow-icon {
                background: none !important;
                border: none !important;
                color: #667eea;
                font-size: 16px;
                text-align: center;
                line-height: 20px;
                transform: rotate(var(--rotation, 0deg));
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>